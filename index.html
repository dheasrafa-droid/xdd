<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSRT Mini Editor</title>
<style>
  body { font-family: sans-serif; background: #f0f0f0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
  #editor { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; width: 100%; }
  #tabs { display: flex; gap: 10px; margin-bottom: 10px; }
  .tab { padding: 10px 20px; background: #eee; border-radius: 5px; cursor: pointer; transition: 0.3s; }
  .tab.active { background: #ddd; }
  #canvasWrapper { position: relative; }
  canvas { border: 1px solid #ccc; max-width: 100%; }
  #tools { margin-top: 10px; display: flex; flex-direction: column; gap: 10px; }
  input[type="range"] { width: 100%; }
  button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; background: #4CAF50; color: white; transition: 0.3s; }
  button:hover { background: #45a049; }
</style>
</head>
<body>

<h1>DSRT Mini Editor</h1>

<div id="editor">
  <input type="file" id="upload" accept="image/*">
  
  <div id="tabs">
    <div class="tab active" data-tool="filter">Filter</div>
    <div class="tab" data-tool="crop">Crop/Rotate</div>
    <div class="tab" data-tool="brush">Brush</div>
    <div class="tab" data-tool="text">Text</div>
    <div class="tab" data-tool="bg">Hapus BG</div>
  </div>

  <div id="canvasWrapper">
    <canvas id="canvas" width="600" height="400"></canvas>
  </div>

  <div id="tools"></div>

  <button id="download">Download Hasil</button>
</div>

<script>
const upload = document.getElementById('upload');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const tabs = document.querySelectorAll('.tab');
const toolsDiv = document.getElementById('tools');
const downloadBtn = document.getElementById('download');

let img = new Image();
let currentTool = 'filter';
let history = [];

function saveHistory() {
  history.push(canvas.toDataURL());
}

function loadImageToCanvas() {
  canvas.width = img.width > 800 ? 800 : img.width;
  canvas.height = img.height > 400 ? 400 : img.height;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  saveHistory();
}

upload.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

img.onload = loadImageToCanvas;

// Tab switch
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentTool = tab.dataset.tool;
    renderTools();
  });
});

// Render tools based on selected tab
function renderTools() {
  toolsDiv.innerHTML = '';
  if(currentTool === 'filter'){
    toolsDiv.innerHTML = `
      <label>Brightness: <input type="range" id="brightness" min="0" max="200" value="100"></label>
      <label>Contrast: <input type="range" id="contrast" min="0" max="200" value="100"></label>
      <label>Grayscale: <input type="range" id="grayscale" min="0" max="100" value="0"></label>
      <button id="reset">Reset Filter</button>
    `;
    const brightness = document.getElementById('brightness');
    const contrast = document.getElementById('contrast');
    const grayscale = document.getElementById('grayscale');
    const reset = document.getElementById('reset');

    function applyFilter() {
      ctx.filter = `brightness(${brightness.value}%) contrast(${contrast.value}%) grayscale(${grayscale.value}%)`;
      loadImageToCanvas();
    }

    brightness.addEventListener('input', applyFilter);
    contrast.addEventListener('input', applyFilter);
    grayscale.addEventListener('input', applyFilter);
    reset.addEventListener('click', () => {
      brightness.value = 100;
      contrast.value = 100;
      grayscale.value = 0;
      applyFilter();
    });
  } else if(currentTool === 'crop'){
    toolsDiv.innerHTML = `
      <button id="rotate">Rotate 90Â°</button>
    `;
    document.getElementById('rotate').addEventListener('click', () => {
      const temp = document.createElement('canvas');
      temp.width = canvas.height;
      temp.height = canvas.width;
      const tctx = temp.getContext('2d');
      tctx.translate(temp.width/2, temp.height/2);
      tctx.rotate(Math.PI/2);
      tctx.drawImage(canvas, -canvas.width/2, -canvas.height/2);
      canvas.width = temp.width;
      canvas.height = temp.height;
      ctx.drawImage(temp, 0, 0);
      saveHistory();
    });
  } else if(currentTool === 'brush'){
    toolsDiv.innerHTML = `
      <label>Color: <input type="color" id="brushColor" value="#ff0000"></label>
      <label>Size: <input type="range" id="brushSize" min="1" max="50" value="5"></label>
    `;
    let drawing = false;
    const brushColor = document.getElementById('brushColor');
    const brushSize = document.getElementById('brushSize');

    canvas.onmousedown = e => drawing = true;
    canvas.onmouseup = e => { drawing = false; saveHistory(); ctx.beginPath(); }
    canvas.onmousemove = e => {
      if(!drawing) return;
      ctx.lineWidth = brushSize.value;
      ctx.lineCap = 'round';
      ctx.strokeStyle = brushColor.value;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }
  } else if(currentTool === 'text'){
    toolsDiv.innerHTML = `
      <label>Text: <input type="text" id="inputText"></label>
      <label>Color: <input type="color" id="textColor" value="#000000"></label>
      <button id="addText">Add Text</button>
    `;
    document.getElementById('addText').addEventListener('click', () => {
      const txt = document.getElementById('inputText').value;
      const color = document.getElementById('textColor').value;
      ctx.fillStyle = color;
      ctx.font = '30px sans-serif';
      ctx.fillText(txt, 50, 50);
      saveHistory();
    });
  } else if(currentTool === 'bg'){
    toolsDiv.innerHTML = `<button id="removeBG">Hapus Background (merah/hijau sederhana)</button>`;
    document.getElementById('removeBG').addEventListener('click', () => {
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const data = imageData.data;
      for(let i=0;i<data.length;i+=4){
        // hapus warna merah/hijau dominan sebagai contoh
        if(data[i] > 150 && data[i+1] < 100 && data[i+2] < 100) data[i+3] = 0;
        if(data[i] < 100 && data[i+1] > 150 && data[i+2] < 100) data[i+3] = 0;
      }
      ctx.putImageData(imageData,0,0);
      saveHistory();
    });
  }
}

// Download hasil
downloadBtn.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'DSRT_result.png';
  link.href = canvas.toDataURL();
  link.click();
});

renderTools();
</script>
</body>
</html>
